<div th:replace="module/sys/dict/dict_crud"></div>

<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md2">
            <div class="layui-card">
                <div class="layui-card-body">
                    <div id="tree"></div>
                </div>
            </div>
        </div>
        <div class="layui-col-md10">
            <div class="layui-card">
                <div class="layui-card-body">
                    <div id="content">
                        <div class="layui-row">
                            <div class="layui-col-md12">
                                <blockquote class="layui-elem-quote layui-quote-nm">
                                    <form class="layui-form layui-form-pane queryFrom" action="">
                                        <div class="layui-form-item">
                                            <div class="layui-inline">
                                                <label class="layui-form-label">名称</label>
                                                <div class="layui-input-inline">
                                                    <input type="text" name="name" placeholder="请输入名称" autocomplete="off"
                                                           class="layui-input">
                                                </div>
                                            </div>

                                            <div class="layui-inline">
                                                <div class="layui-input-inline" style="width: 100%">
                                                    <div class="layui-btn-container">
                                                        <button class="layui-btn layui-btn-sm layui-btn-normal" lay-submit
                                                                lay-filter="queryButton">
                                                            <i class="layui-icon layui-icon-search"></i>查询
                                                        </button>
                                                        <button type="reset" class="layui-btn layui-btn-sm layui-btn-rest">
                                                            <i class="layui-icon layui-icon-refresh-1"></i>重置
                                                        </button>
                                                        <span class="layui-btn layui-btn-sm addButton">
                                                <i class="layui-icon layui-icon-add-circle"></i> 添加
                                            </span>
                                                        <span class="layui-btn layui-btn-sm layui-btn-warm editButton">
                                                <i class="layui-icon layui-icon-edit"></i> 修改
                                            </span>
                                                        <span class="layui-btn layui-btn-sm layui-btn-danger delButton">
                                                <i class="layui-icon layui-icon-delete"></i> 删除
                                            </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </blockquote>
                            </div>
                        </div>

                        <div class="layui-row">
                            <div class="layui-col-md12">
                                <table id="table" lay-filter="table"></table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script th:inline="none">

    layui.use(['form', 'table', 'treetable'], function () {
        var form = layui.form;
        var table = layui.table;
        var treetable = layui.treetable;
        var type;

        //左侧树
        renderTree({
            dom: "tree"
            , click: function (node) {
                renderTable({code: node.id});
            }
        });

        function renderTree(param) {
            var data = getSysData({
                url: "/dict"
                , isTreeTable: true
            });
            initTree({
                dom: param.dom
                , data: data
                , id: "code"
                , pid: "parentCode"
                , name: "name"
                , click: param.click
            });
        }

        //右侧表格

        renderTable();

        function renderTable(whereParam) {
            treetable.render({
                treeColIndex: 1,            // 树形图标显示在第几列（必填）
                treeSpid: 0,                // 顶级pid（必填）
                treeIdName: 'code',           // id字段名
                treePidName: 'parentCode',         // pid字段名
                treeDefaultClose: true,     // 是否默认折叠
                treeLinkage: false,          // 父级展开时是否自动展开所有子级
                elem: '#table',
                url: '/dict',
                where: whereParam,
                cols: [[
                    {checkbox: true}
                    , {field: 'code', title: '字典编码', width: 160}
                    , {field: 'parentCode', title: '上级字典编码', width: 120}
                    , {field: 'name', title: '字典名称'}
                    , {field: 'value', title: '字典值', width: 140}
                    , {
                        field: 'type', title: '字典类型', width: 120, templet: function (d) {
                            return d.type == '1' ? '系统' : ''
                        }
                    }
                    , {
                        field: 'isDefault', title: '是否默认', width: 120, templet: function (d) {
                            return d.isDefault == '1' ? '是' : '否'
                        }
                    }
                    , {field: 'remark', title: '备注', width: 80}
                    , {field: 'sort', title: '排序', width: 80}
                    , {
                        field: 'status', title: '状态', width: 80, templet: function (d) {
                            return d.status == 1 ? '<span class="layui-color-green">正常</span>' : '<span class="layui-color-red">禁用</span>'
                        }
                    }
                ]]
                , done: function (res, curr, count) {
                    checkboxRadio($, "table");
                }
            });
        }


        //查询
        form.on('submit(queryButton)', function (data) {
            renderTable(data.field);
            return false;
        });

        //添加
        $(".addButton").click(function () {
            type = 'POST';
            $("[name='id']").val("");
            $("[name='parentCode']").val("0");
            $("#treeName").text("请选择");
            getDictTreeSelect();
            layerOpen("添加");
        });

        // 修改
        $(".editButton").click(function () {
            type = 'PUT';
            var selectedData = table.checkStatus('table');
            if (selectedData.data.length == 1) {
                getDictTreeSelect();
                $("[name='id']").val(selectedData.data[0].id);
                $("[name='code']").val(selectedData.data[0].code);
                $("[name='parentCode']").val(selectedData.data[0].parentCode);
                $("#treeName").text($("#treeId_" + selectedData.data[0].parentCode).val());
                $("#name").val(selectedData.data[0].name);
                $("[name='value']").val(selectedData.data[0].value);
                $("[name='type']").val(selectedData.data[0].type);
                $("[name='isDefault'][value='" + selectedData.data[0].isDefault + "']").prop("checked", true);
                $("[name='remark']").val(selectedData.data[0].remark);
                $("[name='sort']").val(selectedData.data[0].sort);
                $("[name='status'][value='" + selectedData.data[0].status + "']").prop("checked", true);
                form.render();
                layerOpen("修改");
            } else {
                layer.msg('请选择一条数据', {icon: 0});
            }
        });

        //打开添加/修改 弹出框
        function layerOpen(titleName) {
            openAddOrUpdate({
                title: titleName + '字典'
                , id: "addOrUpdate"
            });
        }

        // 添加/修改 保存
        form.on('submit(saveButton)', function (data) {
            var data = saveOrUpdate({
                url: '/dict'
                , type: type
                , data: data.field
                , tableId: 'table'
                , isTreeTable: true
            });
            if (data.status == "success") {
                renderTable();
                renderTree({
                    dom: "tree"
                    , click: function (node) {
                        renderTable({id: node.id});
                    }
                });
                $('.reset').click();
                layer.msg('保存成功', {icon: 1});
                layer.closeAll('page');
            } else {
                layer.msg(data.message, {icon: 5});
            }
            return false;
        });

        // 删除
        $(".delButton").click(function () {
            var selectedData = table.checkStatus('table');
            if (selectedData.data.length != 0) {
                layer.msg('确定删除？', {
                    time: 0
                    , btn: ['确定', '取消']
                    , yes: function (index) {
                        $.ajax({
                            url: '/dict/' + selectedData.data[0].id
                            , type: 'DELETE'
                            , success: function (data) {
                                if (data.status == "success") {
                                    renderTable();
                                    renderTree({
                                        dom: "tree"
                                        , click: function (node) {
                                            renderTable({id: node.id});
                                        }
                                    });
                                    $('.reset').click();
                                    layer.msg('删除成功', {icon: 1});
                                    layer.close(index);
                                } else {
                                    layer.msg(data.message, {icon: 5});
                                }
                            }
                            , error: function (data) {
                                layer.msg("删除异常", {icon: 5});
                            }
                        });
                    }
                });
            } else {
                layer.msg('请选择一条数据', {icon: 0});
            }
        });


        //获取字典类型
        getDictByCode({
            parentCode: "dict_type"
            , dom: "[name='type']"
            , isParent: true
        });

        //获取字典下拉树
        function getDictTreeSelect() {
            renderTree({
                dom: "parentCode"
                , click: function (node) {
                    var $select = $($(this)[0].elem).parents(".layui-form-select");
                    $select.removeClass("layui-form-selected").find(".layui-select-title span").html(node.name);
                    $("[name='parentCode']").val(node.id);
                }
            });
        }

        downpanel();
    });

</script>

