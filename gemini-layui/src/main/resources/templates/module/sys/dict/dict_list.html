<div th:replace="module/sys/dict/dict_crud"></div>

<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md2">
            <div class="layui-card">
                <div class="layui-card-body">
                    <div id="tree"></div>
                </div>
            </div>
        </div>
        <div class="layui-col-md10">
            <div class="layui-card">
                <div class="layui-card-body">
                    <div id="content">
                        <div class="layui-row">
                            <div class="layui-col-md12">
                                <blockquote class="layui-elem-quote layui-quote-nm">
                                    <form class="layui-form layui-form-pane queryFrom" action="">
                                        <div class="layui-form-item">
                                            <div class="layui-inline">
                                                <label class="layui-form-label">名称</label>
                                                <div class="layui-input-inline">
                                                    <input type="text" name="name" placeholder="请输入名称"
                                                           autocomplete="off"
                                                           class="layui-input">
                                                </div>
                                            </div>

                                            <div class="layui-inline">
                                                <div class="layui-input-inline" style="width: 100%">
                                                    <div class="layui-btn-container">
                                                        <button class="layui-btn layui-btn-sm layui-btn-normal"
                                                                lay-submit
                                                                lay-filter="queryButton">
                                                            <i class="layui-icon layui-icon-search"></i>查询
                                                        </button>
                                                        <button type="reset"
                                                                class="layui-btn layui-btn-sm layui-btn-rest">
                                                            <i class="layui-icon layui-icon-refresh-1"></i>重置
                                                        </button>
                                                        <span class="layui-btn layui-btn-sm addButton">
                                                <i class="layui-icon layui-icon-add-circle"></i> 添加
                                            </span>
                                                        <span class="layui-btn layui-btn-sm layui-btn-warm editButton">
                                                <i class="layui-icon layui-icon-edit"></i> 修改
                                            </span>
                                                        <span class="layui-btn layui-btn-sm layui-btn-danger delButton">
                                                <i class="layui-icon layui-icon-delete"></i> 删除
                                            </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </blockquote>
                            </div>
                        </div>

                        <div class="layui-row">
                            <div class="layui-col-md12">
                                <table id="table" lay-filter="table"></table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script th:inline="none">

    layui.use(['form', 'table', 'treetable'], function () {
        var form = layui.form;
        var table = layui.table;
        var treetable = layui.treetable;
        var type;

        //左侧树
        renderTree({
            dom: "tree"
            , click: function (node) {
                renderTable({code: node.id});
            }
        });

        function renderTree(param) {
            var data = getSysData({
                url: "/sys/dict"
                , data: {pageNum: 1, pageSize: 100000000}
            });
            initTree({
                dom: param.dom
                , data: data
                , id: "id"
                , pid: "pid"
                , name: "name"
                , click: param.click
            });
        }

        //右侧表格

        renderTable();

        function renderTable(whereParam) {
            if (!whereParam) {
                whereParam = {pageNum: 1, pageSize: 100000000};
            }
            treetable.render({
                treeColIndex: 1,            // 树形图标显示在第几列（必填）
                treeSpid: null,                // 顶级pid（必填）
                treeIdName: 'id',           // id字段名
                treePidName: 'pid',         // pid字段名
                treeDefaultClose: true,     // 是否默认折叠
                treeLinkage: false,          // 父级展开时是否自动展开所有子级
                elem: '#table',
                url: '/sys/dict',
                where: whereParam,
                cols: [[
                    {checkbox: true}
                    , {field: 'code', title: '字典编码', width: 160}
                    , {field: 'name', title: '字典名称', width: 160}
                    , {field: 'description', title: '描述'}
                    , {
                        field: 'stateName', title: '状态', width: 80
                    }
                    , {title: '操作', width: 120, toolbar: '#optToolBar'}
                ]]
                , done: function (res, curr, count) {
                    checkboxRadio($, "table");
                }
            });
        }


        //查询
        form.on('submit(queryButton)', function (data) {
            renderTable(data.field);
            return false;
        });

        //添加
        $(".addButton").click(function () {
            type = 'POST';
            $("[name='id']").val("");
            layerOpen("添加");

            table.render({
                elem: '#detailTable'
                , data: []
                , id: 'detailTable'
                , cols: [[
                    {type: 'checkbox', width: 35},
                    {field: 'code', title: '字典编码', width: 200, align: 'left', edit: 'text'},
                    {field: 'name', title: '字典名称', width: 200, align: 'left', edit: 'text'},
                    {field: 'description', title: '描述', align: 'left', edit: 'text'}
                ]]
                , done: function (res, curr, count) {
                }
            });
        });

        // 修改
        $(".editButton").click(function () {
            type = 'PUT';
            let selectedData = table.checkStatus('table');
            if (selectedData.data.length == 1) {
                $("[name='id']").val(selectedData.data[0].id);
                $("[name='code']").val(selectedData.data[0].code);
                $("[name='name']").val(selectedData.data[0].name);
                $("[name='description']").val(selectedData.data[0].description);

                initTable({
                    dom: "detailTable"
                    , url: "/sys/dict"
                    , where: {"pid": selectedData.data[0].id}
                    , cols: [
                        {type: 'checkbox', width: 35},
                        {field: 'id', hide: true},
                        {field: 'code', title: '字典编码', width: 200, align: 'left', edit: 'text'},
                        {field: 'name', title: '字典名称', width: 200, align: 'left', edit: 'text'},
                        {field: 'description', title: '描述', align: 'left', edit: 'text'}
                    ]
                });

                form.render();
                layerOpen("修改");
            } else {
                layer.msg('请选择一条数据', {icon: 0});
            }
        });

        //打开添加/修改 弹出框
        function layerOpen(titleName) {
            openAddOrUpdate({
                title: titleName + '字典'
                , id: "addOrUpdate"
            });
        }

        // 添加/修改 保存
        form.on('submit(saveButton)', function (data) {
            data.field.detailList = table.cache.detailTable;
            let result = saveOrUpdate({
                url: '/sys/dict'
                , type: type
                , data: JSON.stringify(data.field)
                , contentType: 'application/json;charset=utf-8'
                , tableId: 'table'
                , isTreeTable: true
            });
            if (result.success) {
                renderTable();
                renderTree({
                    dom: "tree"
                    , click: function (node) {
                        renderTable({id: node.id});
                    }
                });
                $('.reset').click();
                layer.msg('保存成功', {icon: 1});
                layer.closeAll('page');
            } else {
                layer.msg(result.message, {icon: 5});
            }
            return false;
        });

        // 删除
        $(".delButton").click(function () {
            let selectedData = table.checkStatus('table');
            console.log("selectedData", selectedData)
            return false;
            if (selectedData.data.length != 0) {
                layer.msg('确定删除？', {
                    time: 0
                    , btn: ['确定', '取消']
                    , yes: function (index) {
                        $.ajax({
                            url: '/sys/dict/' + selectedData.data[0].id
                            , type: 'DELETE'
                            , success: function (data) {
                                if (data.success) {
                                    renderTable();
                                    renderTree({
                                        dom: "tree"
                                        , click: function (node) {
                                            renderTable({id: node.id});
                                        }
                                    });
                                    $('.reset').click();
                                    layer.msg('删除成功', {icon: 1});
                                    layer.close(index);
                                } else {
                                    layer.msg(data.message, {icon: 5});
                                }
                            }
                            , error: function (data) {
                                layer.msg("删除异常", {icon: 5});
                            }
                        });
                    }
                });
            } else {
                layer.msg('请选择一条数据', {icon: 0});
            }
        });


        // 新增 明细
        $(".add_detail").click(function () {
            let data = {code: "", name: "", description: ""};
            addRowButton({
                table: "detailTable"
                , id: "code"
                , data: data
            })
        });
        // 批量删除 明细
        $(".delete_detail").click(function () {
            batchDelButton({
                table: "detailTable"
                , id: "code"
            })
        });
    });

</script>

<script type="text/html" id="optToolBar">
    {{#  if(d.status == 1){ }}
    <a class="layui-btn layui-btn-sm layui-btn-danger" lay-event="disable"><i
            class="layui-icon layui-icon-password"></i>禁用</a>
    {{#  } else { }}
    <a class="layui-btn layui-btn-sm layui-btn-rest" lay-event="enabled"><i class="layui-icon layui-icon-auz"></i>启用</a>
    {{#  } }}
</script>
