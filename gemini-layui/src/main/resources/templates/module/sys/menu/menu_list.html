<div th:replace="module/sys/menu/menu_crud"></div>

<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md2">
            <div class="layui-card">
                <div class="layui-card-body">
                    <div id="tree"></div>
                </div>
            </div>
        </div>
        <div class="layui-col-md10">
            <div class="layui-card">
                <div class="layui-card-body">
                    <div id="content">
                        <div class="layui-row">
                            <div class="layui-col-md12">
                                <blockquote class="layui-elem-quote layui-quote-nm">
                                    <form class="layui-form layui-form-pane queryFrom" action="">
                                        <div class="layui-form-item">
                                            <div class="layui-inline">
                                                <label class="layui-form-label">名称</label>
                                                <div class="layui-input-inline">
                                                    <input type="text" name="name" placeholder="请输入名称"
                                                           autocomplete="off"
                                                           class="layui-input">
                                                </div>
                                            </div>

                                            <div class="layui-inline">
                                                <div class="layui-input-inline" style="width: 100%">
                                                    <div class="layui-btn-container">
                                                        <button class="layui-btn layui-btn-sm layui-btn-normal"
                                                                lay-submit
                                                                lay-filter="queryButton">
                                                            <i class="layui-icon layui-icon-search"></i>查询
                                                        </button>
                                                        <button type="reset"
                                                                class="layui-btn layui-btn-sm layui-btn-rest">
                                                            <i class="layui-icon layui-icon-refresh-1"></i>重置
                                                        </button>
                                                        <span class="layui-btn layui-btn-sm addButton">
                                                            <i class="layui-icon layui-icon-add-circle"></i> 添加
                                                        </span>
                                                        <span class="layui-btn layui-btn-sm layui-btn-warm editButton">
                                                            <i class="layui-icon layui-icon-edit"></i> 修改
                                                        </span>
                                                        <span class="layui-btn layui-btn-sm layui-btn-danger delButton">
                                                            <i class="layui-icon layui-icon-delete"></i> 删除
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </blockquote>
                            </div>
                        </div>

                        <div class="layui-row">
                            <div class="layui-col-md12">
                                <table id="table" lay-filter="table"></table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/html" id="typeTpl">
    {{#  if(d.type == "directory"){ }}
    <span class="layui-badge layui-bg-blue">目录</span>
    {{#  } else if(d.type == "menu"){ }}
    <span class="layui-badge layui-bg-green">菜单</span>
    {{#  } else if(d.type == "button"){ }}
    <span class="layui-badge">按钮</span>
    {{#  } }}
</script>
<script th:inline="none">

    layui.use(['form', 'table', 'treetable'], function () {
        var form = layui.form;
        var table = layui.table;
        var treetable = layui.treetable;
        var type;
        //左侧树
        renderTree({
            dom: "tree"
            , click: function (node) {
                renderTable({id: node.id});
            }
        });

        function renderTree(param) {
            var data = getSysData({
                url: "/menu"
                , isTreeTable: true
            });
            initTree({
                dom: param.dom
                , data: data
                , id: "id"
                , pid: "pid"
                , name: "name"
                , click: param.click
            });
        }

        //右侧表格
        renderTable();

        function renderTable(whereParam) {
            treetable.render({
                treeColIndex: 1,            // 树形图标显示在第几列（必填）
                treeSpid: 0,                // 顶级pid（必填）
                treeIdName: 'id',           // id字段名
                treePidName: 'pid',         // pid字段名
                treeDefaultClose: true,     // 是否默认折叠
                treeLinkage: false,          // 父级展开时是否自动展开所有子级
                elem: '#table',
                url: '/menu',
                where: whereParam,
                cols: [[
                    {checkbox: true}
                    , {field: 'name', title: '菜单名称'}
                    , {field: 'type', title: '类型', width: 80, align: 'center', templet: '#typeTpl'}
                    , {field: 'url', title: 'URL', width: 180}
                    , {
                        field: 'icon', title: '图标', width: 80, align: "center", templet: function (d) {
                            return "<i class='layui-icon " + d.icon + "'></i>";
                        }
                    }
                    , {field: 'permissionsCode', title: '权限编码', width: 160}
                    , {field: 'sort', title: '排序', width: 80}
                    , {
                        field: 'status', title: '状态', width: 80, templet: function (d) {
                            return d.status == 1 ? '<span class="layui-color-green">显示</span>' : '<span class="layui-color-red">隐藏</span>'
                        }
                    }
                ]]
                , done: function (res, curr, count) {
                    checkboxRadio($, "table");
                }
            });
        }

        //查询
        form.on('submit(queryButton)', function (data) {
            renderTable(data.field);
            return false;
        });

        //添加
        $(".addButton").click(function () {
            type = 'POST';
            $("[name='id']").val("");
            $("[name='pid']").val("0");
            $("#treeName").text("请选择");
            initFrom();
            getMenuTreeSelect();
            layerOpen("添加");
        });

        // 修改
        $(".editButton").click(function () {
            type = 'PUT';
            var selectedData = table.checkStatus('table');
            if (selectedData.data.length == 1) {
                getMenuTreeSelect();
                $("[name='id']").val(selectedData.data[0].id);
                $("#name").val(selectedData.data[0].name);
                $("[name='pid']").val(selectedData.data[0].pid);
                if (selectedData.data[0].pid == 0) {
                    $("#treeName").text("请选择");
                } else {
                    $("#treeName").text($("#treeId_" + selectedData.data[0].pid).val());
                }
                $("[name='type'][value='" + selectedData.data[0].type + "']").prop("checked", true);
                changeType(selectedData.data[0].type);
                $("[name='url']").val(selectedData.data[0].url);
                $("[name='target']").val(selectedData.data[0].target);
                $("[name='icon']").val(selectedData.data[0].icon);
                $("[name='permissionsCode']").val(selectedData.data[0].permissionsCode);
                $("[name='sort']").val(selectedData.data[0].sort);
                $("[name='status'][value='" + selectedData.data[0].status + "']").prop("checked", true);
                form.render();
                layerOpen("修改");
            } else {
                layer.msg('请选择一条数据', {icon: 0});
            }
        });

        // 打开添加/修改 弹出框
        function layerOpen(titleName) {
            openAddOrUpdate({
                title: titleName + '菜单'
                , id: "addOrUpdate"
                , area: ['520px', '620px']
            });
        }

        // 添加/修改 保存
        form.on('submit(saveButton)', function (data) {
            var data = saveOrUpdate({
                url: '/menu'
                , type: type
                , data: data.field
                , tableId: 'table'
                , isTreeTable: true
            });
            if (data.status == "success") {
                renderTable();
                renderTree({
                    dom: "tree"
                    , click: function (node) {
                        renderTable({id: node.id});
                    }
                });
                $('.reset').click();
                layer.msg('保存成功', {icon: 1});
                layer.closeAll('page');
            } else {
                layer.msg(data.message, {icon: 5});
            }
            return false;
        });

        // 删除
        $(".delButton").click(function () {
            var selectedData = table.checkStatus('table');
            if (selectedData.data.length != 0) {
                layer.msg('确定删除？', {
                    time: 0
                    , btn: ['确定', '取消']
                    , yes: function (index) {
                        $.ajax({
                            url: '/menu/' + selectedData.data[0].id
                            , type: 'DELETE'
                            , success: function (data) {
                                if (data.status == "success") {
                                    renderTable();
                                    renderTree({
                                        dom: "tree"
                                        , click: function (node) {
                                            renderTable({id: node.id});
                                        }
                                    });
                                    $('.reset').click();
                                    layer.msg('删除成功', {icon: 1});
                                    layer.close(index);
                                } else {
                                    layer.msg(data.message, {icon: 5});
                                }
                            }
                            , error: function (data) {
                                layer.msg("删除异常", {icon: 5});
                            }
                        });
                    }
                });
            } else {
                layer.msg('请选择一条数据', {icon: 0});
            }
        });

        //获取菜单类型
        getDictByCode({
            parentCode: "menu_type"
            , dom: "#statusRadio"
            , isRadio: true
            , name: "type"
            , isParent: true
        });

        //获取打开方式
        getDictByCode({
            parentCode: "target_type"
            , dom: "[name='target']"
        });

        //获取菜单下拉树
        function getMenuTreeSelect() {
            renderTree({
                dom: "pid"
                , click: function (node) {
                    var $select = $($(this)[0].elem).parents(".layui-form-select");
                    $select.removeClass("layui-form-selected").find(".layui-select-title span").html(node.name);
                    $("[name='pid']").val(node.id);
                }
            });
        }

        downpanel();

        //初始化表单
        function initFrom() {
            $("#urlDiv").hide();
            $("[name='url']").attr("lay-verify", "");
            $("[name='url']").val("");
            $("#targetDiv").hide();
            $("[name='target']").attr("lay-verify", "");
            $("[name='target']").val("");
            $("#permissionsCodeDiv").hide();
            $("[name='permissionsCode']").attr("lay-verify", "");
            $("[name='permissionsCode']").val("");
            $("#iconDiv").show();
        }

        //菜单类型切换
        form.on('radio(type)', function (data) {
            changeType(data.value);
        });

        function changeType(value) {
            if (value == "directory") {
                initFrom();
            } else if (value == "menu") {
                $("#urlDiv").show();
                $("[name='url']").attr("lay-verify", "required");
                $("#targetDiv").show();
                $("[name='target']").attr("lay-verify", "required");
                $("#permissionsCodeDiv").hide();
                $("[name='permissionsCode']").attr("lay-verify", "");
                $("[name='permissionsCode']").val("");
                $("#iconDiv").show();
            } else if (value == "button") {
                $("#urlDiv").hide();
                $("[name='url']").attr("lay-verify", "");
                $("[name='url']").val("");
                $("#targetDiv").hide();
                $("[name='target']").attr("lay-verify", "");
                $("[name='target']").val("");
                $("#permissionsCodeDiv").show();
                $("[name='permissionsCode']").attr("lay-verify", "required");
                $("#iconDiv").hide();
            }
        }

    });

</script>

